<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Debug - ISKCON Malaysia</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script type="module" src="./firebase-config.js"></script>
    <script type="module" src="./firebase-data.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">Role Debug Tool</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Authentication Status</h2>
            <div id="auth-status" class="text-gray-600">Checking authentication...</div>
            <button id="login-btn" class="bg-blue-500 text-white px-4 py-2 rounded mt-4 hidden">Login</button>
            <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded mt-4 hidden">Logout</button>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">User Role Information</h2>
            <div id="role-info" class="text-gray-600">Please log in to check role</div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">All Users in Database</h2>
            <div id="users-list" class="text-gray-600">Loading users...</div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Debug Actions</h2>
            <button id="refresh-btn" class="bg-green-500 text-white px-4 py-2 rounded mr-2">Refresh Data</button>
            <button id="test-role-btn" class="bg-purple-500 text-white px-4 py-2 rounded">Test Role Function</button>
        </div>
    </div>

    <script type="module">
        import { auth } from './firebase-config.js';
        import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { fetchUsers, getUserRole } from './firebase-data.js';

        let currentUser = null;

        // Initialize debug tool
        document.addEventListener('DOMContentLoaded', function() {
            setupAuthListener();
            loadAllUsers();
            setupEventListeners();
        });

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                const authStatus = document.getElementById('auth-status');
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const roleInfo = document.getElementById('role-info');

                if (user) {
                    authStatus.innerHTML = `
                        <div class="space-y-2">
                            <p><strong>Status:</strong> <span class="text-green-600">Logged In</span></p>
                            <p><strong>UID:</strong> ${user.uid}</p>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Display Name:</strong> ${user.displayName || 'Not set'}</p>
                        </div>
                    `;
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    
                    // Check user role
                    await checkUserRole(user);
                } else {
                    authStatus.innerHTML = '<p class="text-red-600">Not logged in</p>';
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    roleInfo.innerHTML = '<p class="text-gray-600">Please log in to check role</p>';
                }
            });
        }

        async function checkUserRole(user) {
            const roleInfo = document.getElementById('role-info');
            
            try {
                roleInfo.innerHTML = '<p class="text-blue-600">Checking role...</p>';
                
                console.log('=== ROLE CHECK DEBUG ===');
                console.log('User UID:', user.uid);
                console.log('User Email:', user.email);
                
                // Test the getUserRole function
                const userRole = await getUserRole(user.uid, user.email);
                console.log('Role returned:', userRole);
                
                // Also fetch all users to see what's in the database
                const allUsers = await fetchUsers();
                console.log('All users in database:', allUsers);
                
                // Check if user exists by UID
                const userByUid = allUsers[user.uid];
                console.log('User found by UID:', userByUid);
                
                // Check if user exists by email
                const userByEmail = Object.values(allUsers).find(u => 
                    u.email && u.email.toLowerCase() === user.email.toLowerCase()
                );
                console.log('User found by email:', userByEmail);
                
                // Display results
                roleInfo.innerHTML = `
                    <div class="space-y-3">
                        <div class="p-4 bg-gray-50 rounded">
                            <p><strong>Role Detected:</strong> <span class="text-lg font-bold ${userRole === 'admin' || userRole === 'super admin' ? 'text-green-600' : 'text-red-600'}">${userRole}</span></p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded">
                            <p><strong>User by UID:</strong> ${userByUid ? 'Found' : 'Not Found'}</p>
                            ${userByUid ? `<pre class="text-xs mt-2 bg-white p-2 rounded">${JSON.stringify(userByUid, null, 2)}</pre>` : ''}
                        </div>
                        <div class="p-4 bg-gray-50 rounded">
                            <p><strong>User by Email:</strong> ${userByEmail ? 'Found' : 'Not Found'}</p>
                            ${userByEmail ? `<pre class="text-xs mt-2 bg-white p-2 rounded">${JSON.stringify(userByEmail, null, 2)}</pre>` : ''}
                        </div>
                        <div class="p-4 ${userRole === 'admin' || userRole === 'super admin' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'} rounded">
                            <p><strong>Gallery Access:</strong> ${userRole === 'admin' || userRole === 'super admin' ? '✅ GRANTED' : '❌ DENIED'}</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error checking user role:', error);
                roleInfo.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded">
                        <p class="text-red-600"><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadAllUsers() {
            const usersList = document.getElementById('users-list');
            
            try {
                const allUsers = await fetchUsers();
                const userCount = Object.keys(allUsers).length;
                
                if (userCount === 0) {
                    usersList.innerHTML = '<p class="text-yellow-600">No users found in database</p>';
                    return;
                }
                
                const usersHtml = Object.entries(allUsers).map(([uid, userData]) => {
                    const role = userData.role || userData.userRole || userData.permission || userData.level || 'user';
                    return `
                        <div class="p-3 border border-gray-200 rounded mb-2">
                            <p><strong>UID:</strong> ${uid}</p>
                            <p><strong>Email:</strong> ${userData.email || 'Not set'}</p>
                            <p><strong>Name:</strong> ${userData.displayName || userData.name || 'Not set'}</p>
                            <p><strong>Role:</strong> <span class="font-bold ${role === 'admin' || role === 'super admin' ? 'text-green-600' : 'text-blue-600'}">${role}</span></p>
                            <p><strong>Temple:</strong> ${userData.temple || 'Not set'}</p>
                        </div>
                    `;
                }).join('');
                
                usersList.innerHTML = `
                    <p class="mb-4"><strong>Total Users:</strong> ${userCount}</p>
                    <div class="max-h-96 overflow-y-auto">
                        ${usersHtml}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = `<p class="text-red-600">Error loading users: ${error.message}</p>`;
            }
        }

        function setupEventListeners() {
            const refreshBtn = document.getElementById('refresh-btn');
            const testRoleBtn = document.getElementById('test-role-btn');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            refreshBtn.addEventListener('click', () => {
                location.reload();
            });

            testRoleBtn.addEventListener('click', async () => {
                if (!currentUser) {
                    alert('Please log in first to test role function');
                    return;
                }

                try {
                    console.log('=== MANUAL ROLE TEST ===');
                    const role = await getUserRole(currentUser.uid, currentUser.email);
                    alert(`Role Test Result: ${role}\n\nCheck console for detailed logs.`);
                } catch (error) {
                    console.error('Role test error:', error);
                    alert(`Role Test Failed: ${error.message}`);
                }
            });

            loginBtn.addEventListener('click', () => {
                const email = prompt('Enter email:');
                const password = prompt('Enter password:');
                
                if (email && password) {
                    signInWithEmailAndPassword(auth, email, password)
                        .then(() => {
                            console.log('Login successful');
                        })
                        .catch((error) => {
                            alert(`Login failed: ${error.message}`);
                        });
                }
            });

            logoutBtn.addEventListener('click', () => {
                signOut(auth);
            });
        }
    </script>
</body>
</html>
